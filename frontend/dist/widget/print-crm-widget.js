var PrintCRMWidget=function(){"use strict";async function h(a,t){const i=await fetch(a,{headers:{"Content-Type":"application/json"},...t});if(!i.ok)throw new Error(`HTTP ${i.status}`);return i.json()}function e(a,t,i){const n=document.createElement(a);return t&&(n.className=t),i&&(n.textContent=i),n}class l{constructor(t){var n;this.state={categories:[]},this.apiBase=(t==null?void 0:t.apiBase)||"/api";const i=typeof(t==null?void 0:t.container)=="string"?document.querySelector(t.container):(t==null?void 0:t.container)||document.getElementById("print-crm-widget");if(!i)throw new Error("Widget container not found");this.container=i,(n=t==null?void 0:t.theme)!=null&&n.primary&&this.container.style.setProperty("--pc-primary",t.theme.primary)}async init(){const t=await h(`${this.apiBase}/presets`);this.state.categories=t,this.render()}render(){this.container.innerHTML="",this.container.classList.add("pcw");const t=e("h3","","Соберите заказ"),i=e("div","row"),n=e("select");n.appendChild(new Option("Категория",""));for(const s of this.state.categories)n.appendChild(new Option(s.category,s.category));n.onchange=()=>{this.state.cat=this.state.categories.find(s=>s.category===n.value),this.state.item=void 0,this.state.price=void 0,this.render()},i.appendChild(n);const u=e("div","row"),o=e("select");if(o.appendChild(new Option("Позиция","")),this.state.cat)for(const s of this.state.cat.items)o.appendChild(new Option(`${s.description} (${s.price})`,s.description));o.onchange=()=>{var O;const s=(O=this.state.cat)==null?void 0:O.items.find(S=>S.description===o.value);this.state.item=s,this.state.price=s==null?void 0:s.price,this.render()},u.appendChild(o);const y=e("div","row"),r=e("input");r.type="number",r.placeholder="Цена",r.value=String(this.state.price??""),r.oninput=()=>this.state.price=Number(r.value||0),y.appendChild(r);const w=e("div","row"),d=e("input");d.placeholder="Имя";const m=e("input");m.placeholder="Телефон";const p=e("input");p.placeholder="Email",p.type="email",d.oninput=()=>this.state.name=d.value,m.oninput=()=>this.state.phone=m.value,p.oninput=()=>this.state.email=p.value,w.append(d,m,p);const v=e("div","row"),c=e("input");c.placeholder="Предоплата",c.type="number",c.oninput=()=>this.state.prepay=Number(c.value||0),v.append(c);const C=e("button","btn","Оформить и оплатить предоплату");C.onclick=()=>this.submit();const b=e("div","summary"),P=e("div","muted","После оформления вы будете перенаправлены на оплату предоплаты.");b.append(P),this.container.append(t,i,u,y,w,v,C,b)}async submit(){if(!this.state.cat||!this.state.item||!this.state.price)return alert("Выберите позицию и цену");const t=await h(`${this.apiBase}/orders`,{method:"POST",body:JSON.stringify({customerName:this.state.name,customerPhone:this.state.phone,customerEmail:this.state.email,prepaymentAmount:this.state.prepay||0})});await h(`${this.apiBase}/orders/${t.id}/items`,{method:"POST",body:JSON.stringify({type:this.state.cat.category,params:{description:this.state.item.description},price:this.state.price})});const i=await h(`${this.apiBase}/orders/${t.id}/prepay`,{method:"POST",body:JSON.stringify({amount:this.state.prepay||this.state.price})});i.paymentUrl&&(window.location.href=i.paymentUrl)}}return window.PrintCRMWidget={init:async a=>{const t=new l(a);return await t.init(),t}},l}();
